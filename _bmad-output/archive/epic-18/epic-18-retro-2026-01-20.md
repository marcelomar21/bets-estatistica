# Retrospectiva - Epic 18: Sistema de Afiliados

**Data:** 2026-01-20
**Facilitador:** Bob (Scrum Master)
**Participantes:** Marcelomendes, Alice (PO), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev)

---

## Resumo do Epic

| Metrica | Valor |
|---------|-------|
| **Epic** | 18 - Sistema de Afiliados |
| **Stories completadas** | 3/3 (100%) |
| **Testes ao final** | 576 passando |
| **Testes novos no epic** | ~50 testes |
| **Issues de Code Review** | 15 encontrados e corrigidos |
| **Issues HIGH** | 2 (1 em 18.2, 1 em 18.3) |
| **Status** | Completo (pendente validacao real) |

### Stories Entregues

| Story | Titulo | Testes Novos | Destaques |
|-------|--------|--------------|-----------|
| 18.1 | Tracking de Afiliados e Entrada | 26 | Migration 012, deep link, last-click model |
| 18.2 | Logica de Expiracao de Atribuicao | 15 | Job 00:30 BRT, batch processing 500 IDs |
| 18.3 | Link de Pagamento Dinamico com Tracking | 12 | generatePaymentLink(), integracao com reminders |

---

## O Que Foi Bem

### Entrega Rapida e Estruturada

- 3 stories entregues em sequencia, cada uma construindo sobre a anterior
- Zero retrabalho entre stories - arquitetura da 18.1 foi solida
- Campos criados na migration foram suficientes para todas as stories

### Qualidade do Codigo

- Code review encontrou 15 issues antes de ir para producao
- Issues HIGH corrigidos:
  - 18.2: Batch processing para evitar limites Supabase
  - 18.3: Validacao de input null/undefined
- Privacidade: Removido logging de affiliate codes (18.2)

### Cobertura de Testes

- De 120 para 576 testes (+456 novos no projeto)
- TDD aplicado consistentemente
- Testes de edge cases adicionados apos code review

---

## O Que Nao Foi Bem

### Gap Critico: Validacao Real Nao Feita

**Problema:** Sistema implementado sem validar com pagamento real na Cakto.

**O que sabemos:**
- Link de pagamento gerado com `?aff={codigo}`
- Codigo salvo no membro (`affiliate_code`)
- Job de expiracao funcionando (14 dias)

**O que NAO sabemos:**
- Se `?aff=` e o parametro correto da Cakto
- Se o webhook `purchase_approved` traz info do afiliado
- Se precisamos fazer algo no nosso lado para registrar a comissao

**Descoberta importante:** O campo `affiliate` no webhook da Cakto e o EMAIL do afiliado, nao o codigo!

### Git Flow Nao Seguido

- Epic desenvolvido direto na master, sem feature branch
- Codigo ja em producao sem validacao completa
- Risco: rollback dificil se necessario

### Action Items do Epic 16 Parcialmente Cumpridos

| Action Item | Status |
|-------------|--------|
| A1: Checklist pre-code-review | Parcial |
| A2: Validar IDs externos | Parcial (issue em 18.3) |
| A4: Centralizar templates | Nao feito |
| T1: Testes de integracao | Nao feito |
| T4: Refatorar adminGroup.js | Nao feito |

---

## Descobertas Tecnicas

### Payload do Webhook Cakto

```json
{
  "event": "purchase_approved",
  "data": {
    "customer": { "name": "...", "email": "..." },
    "affiliate": "affiliate@example.com",
    "commissions": [
      {
        "user": "teste@teste.com",
        "totalAmount": 1.89,
        "type": "producer",
        "percentage": 80
      }
    ]
  }
}
```

**Nota:** Campo `affiliate` e EMAIL, nao codigo. Pode impactar implementacao.

### Como Testar Webhook

1. Usar Request Bin (webhook.site) para capturar payload
2. Configurar URL temporaria no webhook Cakto
3. Fazer pagamento real via link de afiliado
4. Validar campo `affiliate` no payload capturado

**Nao existe sandbox na Cakto** - testes sao via Request Bin ou pagamento real.

---

## Action Items

### Criticos (Antes de Ativar Afiliados em Producao)

| # | Acao | Owner | Prazo | Status |
|---|------|-------|-------|--------|
| C1 | Criar URL no webhook.site | Marcelomendes | 2026-01-21 | Pendente |
| C2 | Configurar URL temporaria no webhook Cakto | Marcelomendes | 2026-01-21 | Pendente |
| C3 | Criar afiliado de teste na Cakto | Marcelomendes | 2026-01-21 | Pendente |
| C4 | Fazer pagamento real via link de afiliado | Marcelomendes | 2026-01-21 | Pendente |
| C5 | Validar campo `affiliate` no payload | Marcelomendes | 2026-01-21 | Pendente |
| C6 | Documentar payload real recebido | Dev | Apos C5 | Pendente |
| C7 | Ajustar codigo se necessario (email vs codigo) | Dev | Se necessario | Pendente |

### Melhorias de Processo

| # | Acao | Owner | Quando |
|---|------|-------|--------|
| P1 | Usar feature branch para proximos epics | Dev | Proximo epic |
| P2 | Validar integracao com teste real antes de marcar done | Todos | Sempre |
| P3 | Criar checklist de validacao para integracoes externas | Dev | Proximo epic |

---

## Metricas de Code Review

### Distribuicao de Issues por Severidade (Epic 18)

| Severidade | Quantidade | % |
|------------|------------|---|
| High | 2 | 13% |
| Medium | 7 | 47% |
| Low | 6 | 40% |
| **Total** | **15** | 100% |

### Issues por Story

| Story | High | Medium | Low | Total |
|-------|------|--------|-----|-------|
| 18.1 | 0 | 4 | 2 | 6 |
| 18.2 | 1 | 2 | 2 | 5 |
| 18.3 | 1 | 2 | 1 | 4 |

---

## Arquivos Criados/Modificados no Epic 18

### Novos Arquivos

```
sql/migrations/
└── 012_affiliate_tracking.sql

bot/jobs/membership/
└── check-affiliate-expiration.js

__tests__/jobs/membership/
└── check-affiliate-expiration.test.js
```

### Arquivos Modificados

```
bot/services/
├── memberService.js      # +setAffiliateCode, +isAffiliateValid, +clearExpiredAffiliates, +generatePaymentLink
└── notificationService.js # +getPaymentLinkForMember

bot/handlers/
└── startCommand.js       # +extractAffiliateCode, affiliate detection

bot/jobs/membership/
├── trial-reminders.js    # Dynamic payment links
└── renewal-reminders.js  # Dynamic payment links

bot/server.js             # +schedule 00:30 check-affiliate-expiration

__tests__/
├── services/memberService.test.js      # +50 affiliate tests
├── services/notificationService.test.js # +5 payment link tests
└── handlers/startCommand.test.js       # +14 affiliate tests
```

---

## Referencias

- [Cakto - Como funcionam os Webhooks](https://ajuda.cakto.com.br/pt/article/como-funcionam-os-webhooks-1l9m78k/)
- [Cakto - Comissao de Afiliados](https://ajuda.cakto.com.br/pt/article/como-funciona-a-comissao-dos-afiliados-na-cakto-qme0aj/)
- [Cakto API - Webhooks](https://docs.cakto.com.br/api-reference/webhooks/retrieve)
- [Dinamize - Integracao Cakto Webhook](https://help.dinamize.com/article/4000213637-como-integrar-a-cakto-via-webhook-de-entrada)

---

## Conclusao

O Epic 18 foi entregue rapidamente com boa qualidade de codigo e cobertura de testes. No entanto, **a validacao real com a Cakto nao foi feita**, o que representa um risco critico antes de ativar afiliados em producao.

**Proximos passos imediatos:**
1. Validar integracao com pagamento real (amanha)
2. Documentar payload real da Cakto
3. Ajustar codigo se necessario

**Aprendizado principal:** Velocidade de entrega nao substitui validacao real de integracoes externas.

---

## Assinaturas

- **Scrum Master:** Bob
- **Product Owner:** Alice
- **Dev Lead:** Charlie
- **QA:** Dana
- **Stakeholder:** Marcelomendes

_Documento gerado em 2026-01-20 via workflow de retrospectiva BMM_
